@model MileageClaim
@{
    ViewData["Title"] = "Mileage Claim Details";
    var isEditable = Model?.Status.ToString() == "Draft";
}

<div class="container" style="max-width: 1280px; margin: 0 auto; padding: 1.5rem;">
    <!-- Header Card -->
    <div class="custom-card mb-4" style="padding: 1.5rem;">
        <a asp-action="Index" class="btn-link-custom mb-3">
            <i class="bi bi-chevron-left"></i>
            Back to Claims
        </a>
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h1 class="text-dark-custom mb-2" style="font-size: 1.875rem; font-weight: 700;">
                    @(Model.Id != Guid.Empty ? "Mileage Claim Details" : "New Mileage Claim")
                </h1>
                @if (Model.Status != null)
                {
                    @* var statusClass = Model.Status switch *@
                    @* { *@
                    @*     SubmittedToTeamLead => "status-draft", *@
                    @*     "Submitted" => "status-submitted", *@
                    @*     "Approved" => "status-approved", *@
                    @*     "Rejected" => "status-rejected", *@
                    @*     _ => "status-draft" *@
                    @* }; *@
                    @* <span class="status-badge @statusClass">@Model.Status</span> *@
                    <span class="status-badge mt-3 text-success">@Model.Status</span>
                }
            </div>
            @if (isEditable)
            {
                <div class="d-flex gap-2">
                    <button type="button" class="btn-secondary-custom d-flex align-items-center gap-2" onclick="importExcel()">
                        <i class="bi bi-upload" style="font-size: 1.125rem;"></i>
                        Import Excel
                    </button>
                    <button type="button" class="btn-secondary-custom d-flex align-items-center gap-2" onclick="saveDraft()">
                        <i class="bi bi-save" style="font-size: 1.125rem;"></i>
                        Save Draft
                    </button>
                    <button type="button" class="btn-primary-custom d-flex align-items-center gap-2" onclick="submitClaim()">
                        <i class="bi bi-send" style="font-size: 1.125rem;"></i>
                        Submit Claim
                    </button>
                </div>
            }
        </div>
    </div>

    <!-- Messages -->
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show custom-card mb-4" role="alert">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show custom-card mb-4" role="alert">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Claim Period Form -->
    <form asp-action="Edit" method="post" id="claimForm">
        <input type="hidden" asp-for="Id" />
        <input type="hidden" asp-for="Status" />

        <div class="custom-card mb-4" style="padding: 1.5rem;">
            <h2 class="text-dark-custom mb-4" style="font-size: 1.125rem; font-weight: 600;">Claim Period</h2>
            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="StartDate" class="form-label text-dark-custom fw-medium" style="font-size: 0.875rem; margin-bottom: 0.5rem;"></label>
                    <input asp-for="StartDate" class="form-control form-control-custom" type="date" disabled="@(!isEditable)" />
                </div>
                <div class="col-md-6">
                    <label asp-for="EndDate" class="form-label text-dark-custom fw-medium" style="font-size: 0.875rem; margin-bottom: 0.5rem;"></label>
                    <input asp-for="EndDate" class="form-control form-control-custom" type="date" disabled="@(!isEditable)" />
                </div>
               
            </div>
        </div>
    </form>


    <!-- Summary -->
    <div class="custom-card mb-3" style="padding: 1.5rem;">
        <h2 class="text-dark-custom mb-4" style="font-size: 1.125rem; font-weight: 600;">Summary</h2>
        <div class="row g-4" style="max-width: 500px;">
            <div class="col-md-6">
                <div class="summary-card-blue">
                    <p>Total Kilometers</p>
                    <h3 id="totalKilometers">@Model.TotalKilometers.ToString() km</h3>
                </div>
            </div>
            <div class="col-md-6">
                <div class="summary-card-green">
                    <p>Total Reimbursement</p>
                    <h3 id="totalReimbursement">$@Model.TotalReimbursement.ToString()</h3>
                </div>
            </div>
        </div>
    </div>
    <!-- Trips Table -->
    <div class="custom-card mb-4" style="padding: 1.5rem;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-dark-custom mb-0" style="font-size: 1.125rem; font-weight: 600;">Trip Details</h2>
            @if (isEditable)
            {
                <button type="button" class="btn-primary-custom d-flex align-items-center gap-2" onclick="addTrip()">
                    <i class="bi bi-plus" style="font-size: 1.125rem;"></i>
                    Add Trip
                </button>
            }
        </div>

        <div class="table-responsive">
            <table class="table table-custom mb-0" id="tripsTable">
                <thead>
                    <tr>
                        <th style="width: 140px;">Date</th>
                        <th style="width: 100px;">Time</th>
                        <th>Description</th>
                        <th>Starting Location</th>
                        <th>End Location</th>
                        <th style="width: 120px;" class="text-end">Kilometers</th>
                        <th style="width: 130px;" class="text-end">Reimbursement</th>
                        @if (isEditable)
                        {
                            <th style="width: 80px;" class="text-center">Actions</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @if (!Model.Trips.Any())
                    {
                        <tr>
                            <td colspan="8" class="text-center text-muted-custom" style="padding: 3rem;">
                                No trips added yet. Click "Add Trip" to get started.
                            </td>
                        </tr>
                    }
                    @foreach (var trip in Model.Trips)
                    {
                        <tr data-trip-id="@trip.Id">
                            <td>
                                <input type="date" class="form-control-sm w-100" value="@trip.TripDate.ToString("yyyy-MM-dd")"
                                       disabled="@(!isEditable)" data-field="TripDate" style="border: 1px solid var(--gray-300); border-radius: 0.375rem; padding: 0.25rem 0.5rem;" />
                            </td>
                          
                            <td>
                                <input type="text" class="form-control-sm w-100" value="@trip.Description"
                                       placeholder="Trip description" disabled="@(!isEditable)" data-field="Description" style="border: 1px solid var(--gray-300); border-radius: 0.375rem; padding: 0.25rem 0.5rem;" />
                            </td>
                            <td>
                                <input type="text" class="form-control-sm w-100" value="@trip.StartLocation"
                                       placeholder="Start location" disabled="@(!isEditable)" data-field="StartLocation" style="border: 1px solid var(--gray-300); border-radius: 0.375rem; padding: 0.25rem 0.5rem;" />
                            </td>
                            <td>
                                <input type="text" class="form-control-sm w-100" value="@trip.EndLocation"
                                       placeholder="End location" disabled="@(!isEditable)" data-field="EndLocation" style="border: 1px solid var(--gray-300); border-radius: 0.375rem; padding: 0.25rem 0.5rem;" />
                            </td>
                            <td>
                                <input type="number" step="0.1" class="form-control-sm w-100 text-end"
                                       value="@trip.Kilometers" disabled="@(!isEditable)" data-field="Kilometers"
                                       onchange="calculateReimbursement(this)" style="border: 1px solid var(--gray-300); border-radius: 0.375rem; padding: 0.25rem 0.5rem;" />
                            </td>
                            <td class="text-end fw-medium text-dark-custom">
                                $<span class="reimbursement-value">@trip.Reimbursement.ToString("N2")</span>
                            </td>
                            @if (isEditable)
                            {
                                <td class="text-center">
                                    <button type="button" class="btn btn-sm btn-link text-danger p-0"
                                            onclick="deleteTrip('@trip.Id')" style="border: none; background: none;">
                                        <i class="bi bi-trash" style="font-size: 1rem;"></i>
                                    </button>
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

  
 </div>
@section Scripts {
<script>
    console.log("Hello");
        console.log("hello from script");
        
       
</script>
<script>
        
        const claimId = '@Model.Id';
        const ratePerKm = @Model.RatePerKm;
        const isEditable = @(isEditable ? "true" : "false");

       

        function updateTotals() {
            let totalKm = 0;
            document.querySelectorAll('[data-field="Kilometers"]').forEach(input => {
                totalKm += parseFloat(input.value) || 0;
            });
            const totalReimbursement = totalKm * ratePerKm;

            document.getElementById('totalKilometers').textContent = totalKm.toFixed(2) + ' km';
        document.getElementById('totalReimbursement').textContent = '$' + totalReimbursement.toFixed(2);        }
         function addTrip() {
            const tbody = document.querySelector('#tripsTable tbody');
            const newRow = document.createElement('tr');
            newRow.setAttribute('data-trip-id', 'new');
            newRow.innerHTML = `
                <td><input type="date" class="form-control-sm w-100" data-field="TripDate" style="border: 1px solid var(--gray-300); border-radius: 0.375rem; padding: 0.25rem 0.5rem;" /></td>
                <td><input type="time" class="form-control-sm w-100" placeholder="HH:MM" data-field="TripTime" style="border: 1px solid var(--gray-300); border-radius: 0.375rem; padding: 0.25rem 0.5rem;" /></td>
                <td><input type="text" class="form-control-sm w-100" placeholder="Description" data-field="Description" style="border: 1px solid var(--gray-300); border-radius: 0.375rem; padding: 0.25rem 0.5rem;" /></td>
                <td><input type="text" class="form-control-sm w-100" placeholder="Start" data-field="StartLocation" style="border: 1px solid var(--gray-300); border-radius: 0.375rem; padding: 0.25rem 0.5rem;" /></td>
                <td><input type="text" class="form-control-sm w-100" placeholder="End" data-field="EndLocation" style="border: 1px solid var(--gray-300); border-radius: 0.375rem; padding: 0.25rem 0.5rem;" /></td>
                <td><input type="number" step="0.1" class="form-control-sm w-100 text-end" data-field="Kilometers" onchange="calculateReimbursement(this)" style="border: 1px solid var(--gray-300); border-radius: 0.375rem; padding: 0.25rem 0.5rem;" /></td>
                <td class="text-end fw-medium text-dark-custom">$<span class="reimbursement-value">0.00</span></td>
                <td class="text-center">
                    <button type="button" class="btn btn-sm btn-link text-success p-0 me-2" onclick="saveNewTrip(this)" style="border: none; background: none;">
                        <i class="bi bi-check-lg" style="font-size: 1.25rem;"></i> save
                    </button>
                    <button type="button" class="btn btn-sm btn-link text-danger p-0" onclick="this.closest('tr').remove()" style="border: none; background: none;">
                        <i class="bi bi-x-lg" style="font-size: 1rem;"></i> Delete
                    </button>
                </td>
            `;

            if (tbody.querySelector('td[colspan]')) {
                tbody.innerHTML = '';
            }
            tbody.appendChild(newRow);

            // Focus on date field
            newRow.querySelector('[data-field="TripDate"]').focus();
        }
        function calculateReimbursement(input) {
                const kilometers = parseFloat(input.value) || 0;
                const reimbursement = kilometers * ratePerKm;
                const row = input.closest('tr');
                row.querySelector('.reimbursement-value').textContent = reimbursement.toFixed(2);
                updateTotals();
        }

        async function saveNewTrip(btn) {
            const row = btn.closest('tr');
            const tripData = {
                TripDate: row.querySelector('[data-field="TripDate"]').value,
                TripTime: row.querySelector('[data-field="TripTime"]').value,
                Description: row.querySelector('[data-field="Description"]').value,
                StartLocation: row.querySelector('[data-field="StartLocation"]').value,
                EndLocation: row.querySelector('[data-field="EndLocation"]').value,
                Kilometers: parseFloat(row.querySelector('[data-field="Kilometers"]').value) || 0
            };

            // Basic validation
            if (!tripData.TripDate) {
                alert('Please enter a trip date');
                return;
            }
            if (!tripData.StartLocation) {
                alert('Please enter a starting location');
                return;
            }
            if (!tripData.EndLocation) {
                alert('Please enter an end location');
                return;
            }
            if (tripData.Kilometers <= 0) {
                alert('Please enter valid kilometers');
                return;
            }

            try {
                const response = await fetch('/Mileage/AddTrip?claimId=' + claimId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    },
                    body: JSON.stringify(tripData)
                });

                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    alert(result.message || 'Failed to add trip');
                }
            } catch (error) {
                console.error('Error saving trip:', error);
                alert('An error occurred while saving the trip');
            }
        }

        async function deleteTrip(tripId) {
            if (!confirm('Are you sure you want to delete this trip?')) return;

            try {
                const response = await fetch('/Mileage/DeleteTrip?id=' + tripId, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    }
                });

                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    alert(result.message || 'Failed to delete trip');
                }
            } catch (error) {
                console.error('Error deleting trip:', error);
                alert('An error occurred while deleting the trip');
            }
        }

        async function submitClaim() {
            const tbody = document.querySelector('#tripsTable tbody');
            const hasPendingTrip = tbody.querySelector('[data-trip-id="new"]');

            if (hasPendingTrip) {
                alert('Please save or cancel the trip you are currently adding before submitting.');
                return;
            }

            const tripCount = tbody.querySelectorAll('tr[data-trip-id]').length;
            if (tripCount === 0) {
                alert('Cannot submit a claim with no trips. Please add at least one trip.');
                return;
            }

            if (!confirm('Submit this claim for approval? You will not be able to edit it afterwards.')) return;

            try {
                const response = await fetch('/Mileage/Submit?id=' + claimId, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    }
                });

                const result = await response.json();
                if (result.success) {
                    window.location.href = '/Mileage/Index';
                } else {
                    alert(result.message || 'Failed to submit claim');
                }
            } catch (error) {
                console.error('Error submitting claim:', error);
                alert('An error occurred while submitting the claim');
            }
        }

        function saveDraft() {
            const hasPendingTrip = document.querySelector('[data-trip-id="new"]');
            if (hasPendingTrip) {
                alert('Please save or cancel the trip you are currently adding before saving the draft.');
                return;
            }

            document.getElementById('claimForm').submit();
        }

        function importExcel() {
            alert('Excel import feature coming soon! This will allow you to upload your Excel mileage log and automatically populate the trips.');
        }

        // Update totals on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateTotals();
        });
</script>
}