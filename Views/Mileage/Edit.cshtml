@model MileageClaim
@{
    ViewData["Title"] = "Mileage Claim Details";
    var isEditable = Model?.Status.ToString() == "Draft";
}

@section Styles {
<link rel="stylesheet" href="~/css/edit.css" />
}

<div class="container" style="max-width: 1280px; margin: 0 auto; padding: 1.5rem;">
    <!-- Header Card -->
    <div class="custom-card mb-4" style="padding: 1.5rem;">
        <a asp-action="Index" class="btn-link-custom mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left-short" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M12 8a.5.5 0 0 1-.5.5H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5a.5.5 0 0 1 .5.5" />
            </svg>
            Back to Claims
        </a>
        <div class="d-flex justify-content-between align-items-start">
            <div>

                <h1 class="text-dark-custom mb-2" style="font-size: 1.875rem; font-weight: 700;">
                    @(Model?.Id != Guid.Empty ? "Mileage Claim Details" : "New Mileage Claim")
                    
                    @if (Model?.Status == ClaimStatus.SubmittedToTeamLead)
                    {
                        <span class="status-badge status-approved">Pending Team Lead</span>
                    }
                    else if (Model?.Status == ClaimStatus.TeamLeadApproved)
                    {
                        <span class="status-badge  status-approved">Approved by Team Lead and pending Finance</span>
                    }
                    @* else if (Model?.Status == ClaimStatus.SubmittedToFinance) *@
                    @* { *@
                    @*     <span class="status-badge status-submitted">Pending Finance</span> *@
                    @* } *@
                    else if (Model?.Status == ClaimStatus.FinanceApproved)
                    {
                        <span class="status-badge status-submitted">Finance Approved</span>
                    }
                    else if (Model?.Status == ClaimStatus.TeamLeadRejected || Model?.Status == ClaimStatus.FinanceRejected)
                    {
                        <span class="status-badge status-rejected">Rejected</span>
                    }
                    </h1>
            </div>
          
    </div>


    @if (TempData["Success"] != null)
    {
        <script>
            document.addEventListener('DOMContentLoaded', function() {
            Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: '@TempData["Success"]',
            confirmButtonColor: '#10b981',
            timer: 3000,
         
            showConfirmButton: true
            });
            });
        </script>
    }

    @if (TempData["Error"] != null)
    {
        <script>
            document.addEventListener('DOMContentLoaded', function() {
            Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: '@TempData["Error"]',
            confirmButtonColor: '#ef4444',
            confirmButtonText: 'OK'
            });
            });
        </script>
    }

    <!-- Claim Period Form -->
    <form asp-action="Edit" method="post" id="claimForm">
        <input type="hidden" asp-for="Id" />
        <input type="hidden" asp-for="Status" />


        

        <div class="custom-card mb-4" style="padding: 1.5rem;">
            <h2 class="text-dark-custom mb-4" style="font-size: 1.125rem; font-weight: 600;">Claim Details</h2>
            <div class="row g-3">
                    <div class="col-md-3">
                        <label asp-for="EmployeeName" class="form-label text-dark-custom fw-medium" style="font-size: 0.875rem; margin-bottom: 0.5rem;"></label>
                        <input asp-for="EmployeeName" class="form-control form-control-custom" type="text" disabled="@(!isEditable)" />
                    </div>
                <div class="col-md-3">
                        <label asp-for="TeamLeadApprover" class="form-label text-dark-custom fw-medium" style="font-size: 0.875rem; margin-bottom: 0.5rem;"></label>
                        <input asp-for="TeamLeadApprover" class="form-control form-control-custom" type="text" disabled="@(!isEditable)" />
                </div>
                    <div class="col-md-3">
                        <label asp-for="StartDate" class="form-label text-dark-custom fw-medium" style="font-size: 0.875rem; margin-bottom: 0.5rem;"></label>
                        <input asp-for="StartDate" class="form-control form-control-custom" type="date" disabled="@(!isEditable)" />
                    </div>
                <div class="col-md-3">
                    <label asp-for="EndDate" class="form-label text-dark-custom fw-medium" style="font-size: 0.875rem; margin-bottom: 0.5rem;"></label>
                    <input asp-for="EndDate" class="form-control form-control-custom" type="date" disabled="@(!isEditable)" />
                </div>
            </div>
        </div>
    </form>

    <!-- Summary -->
    <div class="custom-card mb-3" style="padding: 1.5rem;">
        <h2 class="text-dark-custom mb-4" style="font-size: 1.125rem; font-weight: 600;">Summary</h2>
        <div class="row g-4" style="max-width: 500px;">
            <div class="col-md-6">
                <div class="summary-card-blue">
                    <p>Total Kilometers</p>
                    <h3 id="totalKilometers">@Model.TotalKilometers.ToString() km</h3>
                </div>
            </div>
            <div class="col-md-6">
                <div class="summary-card-green">
                    <p>Total Reimbursement</p>
                    <h3 id="totalReimbursement">$@Model.TotalReimbursement.ToString()</h3>
                </div>
            </div>
        </div>
    </div>
    <!-- Trips Table -->
    <div class="custom-card mb-4" style="padding: 1.5rem;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-dark-custom mb-0" style="font-size: 1.125rem; font-weight: 600;">Trip Details</h2>
            @if (isEditable)
            {
                <button type="button" class="btn-primary-custom d-flex align-items-center gap-2" onclick="addTrip()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="1.125em" height="1.125em" fill="currentColor" class="bi bi-plus" viewBox="0 0 16 16">
                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z" />
                    </svg>
                    Add Trip
                </button>
            }
        </div>

        <div class="table-responsive">
            <table class="table table-custom mb-0" id="tripsTable">
                <thead>
                    <tr>
                        <th style="width: 140px;">Date</th>
                        @* <th>Time</th> *@
                        <th>Description</th>
                        <th>Starting Location</th>
                        <th>End Location</th>
                        <th style="width: 120px;" class="text-end">Kilometers</th>
                        <th style="width: 130px;" class="text-end">Reimbursement</th>
                        @if (isEditable)
                        {
                            <th style="width: 80px;" class="text-center">Actions</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @if (!Model.Trips.Any())
                    {
                        <tr>
                            <td colspan="8" class="text-center text-muted-custom" style="padding: 3rem;">
                                No trips added yet. Click "Add Trip" to get started.
                            </td>
                        </tr>
                    }
                    @foreach (var trip in Model.Trips)
                    {
                        <tr data-trip-id="@trip.Id">
                            <td>
                                <input type="date" class="form-control-sm w-100" value="@trip.TripDate.ToString("yyyy-MM-dd")"
                                disabled="@(!isEditable)" data-field="TripDate" style="border: 1px solid var(--gray-300); border-radius: 0.375rem; padding: 0.25rem 0.5rem;" />
                            </td>
                            @* <td> *@
                            @*     <input type="text" class="form-control-sm w-100" value="@trip.TripDate." *@
                            @*            placeholder="Trip description" disabled="@(!isEditable)" data-field="Description" style="border: 1px solid var(--gray-300); border-radius: 0.375rem; padding: 0.25rem 0.5rem;" /> *@
                            @* </td> *@
                            <td>
                                <input type="text" class="form-control-sm w-100" value="@trip.Description"
                                placeholder="Trip description" disabled="@(!isEditable)" data-field="Description" style="border: 1px solid var(--gray-300); border-radius: 0.375rem; padding: 0.25rem 0.5rem;" />
                            </td>
                            <td>
                                <input type="text" class="form-control-sm w-100" value="@trip.StartLocation"
                                placeholder="Start location" disabled="@(!isEditable)" data-field="StartLocation" style="border: 1px solid var(--gray-300); border-radius: 0.375rem; padding: 0.25rem 0.5rem;" />
                            </td>
                            <td>
                                <input type="text" class="form-control-sm w-100" value="@trip.EndLocation"
                                placeholder="End location" disabled="@(!isEditable)" data-field="EndLocation" style="border: 1px solid var(--gray-300); border-radius: 0.375rem; padding: 0.25rem 0.5rem;" />
                            </td>
                            <td>
                                <input type="number" step="0.1" class="form-control-sm w-100 text-end"
                                value="@trip.Kilometers" disabled="@(!isEditable)" data-field="Kilometers"
                                onchange="calculateReimbursement(this)" style="border: 1px solid var(--gray-300); border-radius: 0.375rem; padding: 0.25rem 0.5rem;" />
                            </td>
                            <td class="text-end fw-medium text-dark-custom">
                                $<span class="reimbursement-value">@trip.Reimbursement.ToString("N2")</span>
                            </td>
                            @if (isEditable)
                            {
                                <td class="text-center">
                                    <button type="button" class="btn btn-sm btn-link text-danger p-0"
                                    onclick="deleteTrip('@trip.Id')" style="border: none; background: none;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16">
                                            <path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5M8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5m3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0" />
                                        </svg>
                                    </button>
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    @{
        bool showApprovalSection = false;

        if (User.IsInRole("TeamLead") && Model.Status == ClaimStatus.SubmittedToTeamLead)
        {
            showApprovalSection = true;
        }

        if (User.IsInRole("Finance") && Model.Status == ClaimStatus.TeamLeadApproved)
        {
            showApprovalSection = true;
        }
    }
    @if (showApprovalSection)
    {
        <div style="max-width: 800px; margin: 0 auto;">
            <div class="mb-3">
                <label asp-for="TeamLeadComment" class="form-label text-dark-custom fw-medium"
                       style="font-size: 0.875rem; margin-bottom: 0.5rem;">
                    Comments (Optional)
                </label>
                <textarea id="approvalComment" asp-for="TeamLeadComment"
                          class="form-control"
                          rows="3"
                          placeholder="Add any comments or notes about this claim..."
                          style="border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.75rem; font-size: 0.875rem; resize: vertical;">
                </textarea>
                <small class="text-muted" style="font-size: 0.75rem;">
                    Your comments will be visible to the @Model.EmployeeName
                </small>
            </div>

            <div class="d-flex gap-3">
                <button type="button"
                        class="btn flex-grow-1 approve-btn"
                        onclick="approveClaim('@Model.Id')"
                        style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                           color: white; border: none; border-radius: 0.5rem;
                           padding: 1rem; font-weight: 600;">
                    Approve Claim
                </button>

                <button type="button"
                        class="btn flex-grow-1 reject-btn"
                        onclick="rejectClaim('@Model.Id')"
                        style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                           color: white; border: none; border-radius: 0.5rem;
                           padding: 1rem; font-weight: 600;">
                    Reject Claim
                </button>
            </div>
        </div>
    }


    @* @if (Model.Status != ClaimStatus.Rejected & Model.Status != ClaimStatus.TeamLeadApproved & Model.Status != ClaimStatus.FinanceApproved) *@
    @* { *@
    @*     @if(User.IsInRole("Finance") || User.IsInRole("TeamLead")) *@
    @*     { *@
    @*         <div style="max-width: 800px; margin: 0 auto;"> *@
    @*             <div class="mb-3"> *@
    @*                 <label asp-for="TeamLeadComment" class="form-label text-dark-custom fw-medium" style="font-size: 0.875rem; margin-bottom: 0.5rem;"> *@
    @*                     Comments (Optional) *@
    @*                 </label> *@
    @*                 <textarea id="approvalComment" asp-for="TeamLeadComment" *@
    @*                           class="form-control" *@
    @*                           rows="3" *@
    @*                           placeholder="Add any comments or notes about this claim..." *@
    @*                           style="border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.75rem; font-size: 0.875rem; resize: vertical;"></textarea> *@
    @*                 <small class="text-muted" style="font-size: 0.75rem;">Your comments will be visible to the @Model.EmployeeName</small> *@
    @*             </div> *@

    @*             <div class="d-flex gap-3"> *@
    @*                 <button type="button" class="btn flex-grow-1 approve-btn" onclick="approveClaim('@Model.Id')" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 0.5rem; padding: 1rem; font-weight: 600; transition: transform 0.2s;"> *@
    @*                     <svg xmlns="http://www.w3.org/2000/svg" width="1.25em" height="1.25em" fill="currentColor" class="bi bi-check-circle-fill me-2" viewBox="0 0 16 16"> *@
    @*                         <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM6.97 11.03a.75.75 0 0 0 1.07 0l3-3a.75.75 0 1 0-1.06-1.06L7.5 9.44 6.03 7.97a.75.75 0 1 0-1.06 1.06l2 2z" /> *@
    @*                     </svg> *@
    @*                     Approve Claim *@
    @*                 </button> *@
    @*                 <button type="button" class="btn flex-grow-1 reject-btn" onclick="rejectClaim('@Model.Id')" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; border-radius: 0.5rem; padding: 1rem; font-weight: 600; transition: transform 0.2s;"> *@
    @*                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-circle-fill" viewBox="0 0 16 16"> *@
    @*                         <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293z" /> *@
    @*                     </svg> *@
    @*                     Reject Claim *@
    @*                 </button> *@
    @*             </div> *@
    @*         </div> *@
    @*     } *@
       
    @* } *@
</div>
    @section Scripts {

        <script>
            const claimId = '@Model.Id';
            const ratePerKm = @Model.RatePerKm;
            const isEditable = @(isEditable ? "true" : "false")

            function updateTotals() {
                let totalKm = 0;
                document.querySelectorAll('[data-field="Kilometers"]').forEach(input => {
                    totalKm += parseFloat(input.value) || 0;
                });
                const totalReimbursement = totalKm * ratePerKm;

                document.getElementById('totalKilometers').textContent = totalKm.toFixed(2) + ' km';
                document.getElementById('totalReimbursement').textContent = '$' + totalReimbursement.toFixed(2);
            }

            function addTrip() {
                const tbody = document.querySelector('#tripsTable tbody');
                const newRow = document.createElement('tr');
                newRow.setAttribute('data-trip-id', 'new');
                newRow.innerHTML = `
                    <td><input type="date" class="form-control-sm w-100" data-field="TripDate" style="border: 1px solid var(--gray-300); border-radius: 0.375rem; padding: 0.25rem 0.5rem;" /></td>
                    <td><input type="time" class="form-control-sm w-100" placeholder="HH:MM" data-field="TripTime" style="border: 1px solid var(--gray-300); border-radius: 0.375rem; padding: 0.25rem 0.5rem;" /></td>
                    <td><input type="text" class="form-control-sm w-100" placeholder="Description" data-field="Description" style="border: 1px solid var(--gray-300); border-radius: 0.375rem; padding: 0.25rem 0.5rem;" /></td>
                    <td><input type="text" class="form-control-sm w-100" placeholder="Start" data-field="StartLocation" style="border: 1px solid var(--gray-300); border-radius: 0.375rem; padding: 0.25rem 0.5rem;" /></td>
                    <td><input type="text" class="form-control-sm w-100" placeholder="End" data-field="EndLocation" style="border: 1px solid var(--gray-300); border-radius: 0.375rem; padding: 0.25rem 0.5rem;" /></td>
                    <td><input type="number" step="0.1" class="form-control-sm w-100 text-end" data-field="Kilometers" onchange="calculateReimbursement(this)" style="border: 1px solid var(--gray-300); border-radius: 0.375rem; padding: 0.25rem 0.5rem;" /></td>
                    <td class="text-end fw-medium text-dark-custom">$<span class="reimbursement-value">0.00</span></td>
                    <td class="text-center">
                      
                        <button type="button" class="btn btn-sm btn-link text-danger p-0" onclick="this.closest('tr').remove()" style="border: none; background: none;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16">
                                <path d="M2.146 2.146a.5.5 0 0 1 .708 0L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854a.5.5 0 0 1 0-.708z"/>
                            </svg> Delete
                        </button>
                    </td>
                `;

                if (tbody.querySelector('td[colspan]')) {
                    tbody.innerHTML = '';
                }
                tbody.appendChild(newRow);

                // Focus on date field
                newRow.querySelector('[data-field="TripDate"]').focus();
            }

            function calculateReimbursement(input) {
                const kilometers = parseFloat(input.value) || 0;
                const reimbursement = kilometers * ratePerKm;
                const row = input.closest('tr');
                row.querySelector('.reimbursement-value').textContent = reimbursement.toFixed(2);
                updateTotals();
            }

            // async function saveNewTrip(btn) {
            //     const row = btn.closest('tr');
            //     const tripData = {
            //         TripDate: row.querySelector('[data-field="TripDate"]').value,
            //         TripTime: row.querySelector('[data-field="TripTime"]').value,
            //         Description: row.querySelector('[data-field="Description"]').value,
            //         StartLocation: row.querySelector('[data-field="StartLocation"]').value,
            //         EndLocation: row.querySelector('[data-field="EndLocation"]').value,
            //         Kilometers: parseFloat(row.querySelector('[data-field="Kilometers"]').value) || 0
            //     };

            //     Basic validation
            //    
            //     try {
            //         const response = await fetch('/Mileage/AddTrip?claimId=' + claimId, {
            //             method: 'POST',
            //             headers: {
            //                 'Content-Type': 'application/json',
            //                 'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
            //             },
            //             body: JSON.stringify(tripData)
            //         });

            //         const result = await response.json();
            //         if (result.success) {
            //             location.reload();
            //         } else {
            //             Swal.fire({ icon: 'error', title: 'Error', text: result.message || 'Failed to add trip' });
            //         }
            //     } catch (error) {
            //         console.error('Error saving trip:', error);
            //         Swal.fire({ icon: 'error', title: 'Error', text: 'An error occurred while saving the trip' });
            //     }
            // }

            async function deleteTrip(tripId) {
                const result = await Swal.fire({
                    icon: 'warning',
                    title: 'Delete Trip?',
                    text: 'Are you sure you want to delete this trip?',
                    showCancelButton: true,
                    confirmButtonColor: '#ef4444',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Yes, Delete',
                    cancelButtonText: 'Cancel'
                });
                if (!result.isConfirmed) return;

                try {
                    const response = await fetch('/Mileage/DeleteTrip?id=' + tripId, {
                        method: 'POST',
                        headers: {
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                        }
                    });

                    const res = await response.json();
                    if (res.success) {
                        location.reload();
                    } else {
                        Swal.fire({ icon: 'error', title: 'Error', text: res.message || 'Failed to delete trip' });
                    }
                } catch (error) {
                    console.error('Error deleting trip:', error);
                    Swal.fire({ icon: 'error', title: 'Error', text: 'An error occurred while deleting the trip' });
                }
            }

            async function submitClaim() {
                const tbody = document.querySelector('#tripsTable tbody');
                const hasPendingTrip = tbody.querySelector('[data-trip-id="new"]');

                if (hasPendingTrip) {
                    Swal.fire({ icon: 'warning', title: 'Pending Trip', text: 'Please save or cancel the trip you are currently adding before submitting.' });
                    return;
                }

                const tripCount = tbody.querySelectorAll('tr[data-trip-id]').length;
                if (tripCount === 0) {
                    Swal.fire({ icon: 'warning', title: 'No Trips', text: 'Cannot submit a claim with no trips. Please add at least one trip.' });
                    return;
                }

                const result = await Swal.fire({
                    icon: 'question',
                    title: 'Submit Claim?',
                    text: 'Submit this claim for approval? You will not be able to edit it afterwards.',
                    showCancelButton: true,
                    confirmButtonColor: '#10b981',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Yes, Submit',
                    cancelButtonText: 'Cancel'
                });
                if (!result.isConfirmed) return;

                try {
                    const response = await fetch('/Mileage/Submit?id=' + claimId, {
                        method: 'POST',
                        headers: {
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                        }
                    });

                    const res = await response.json();
                    if (res.success) {
                        window.location.href = '/Mileage/Index';
                    } else {
                        Swal.fire({ icon: 'error', title: 'Error', text: res.message || 'Failed to submit claim' });
                    }
                } catch (error) {
                    console.error('Error submitting claim:', error);
                    Swal.fire({ icon: 'error', title: 'Error', text: 'An error occurred while submitting the claim' });
                }
            }

            function saveDraft() {
                // const hasPendingTrip = document.querySelector('[data-trip-id="new"]');
                // if (hasPendingTrip) {
                //     Swal.fire({ icon: 'warning', title: 'Pending Trip', text: 'Please save or cancel the trip you are currently adding before saving the draft.' });
                //     return;
                // }
                document.getElementById('claimForm').submit();
            }

            function importExcel() {
                Swal.fire({
                    icon: 'info',
                    title: 'Coming Soon',
                    text: 'Excel import feature coming soon! This will allow you to upload your Excel mileage log and automatically populate the trips.'
                });
            }

            document.addEventListener('DOMContentLoaded', function() {
                updateTotals();
            });

                    function approveClaim(claimId) {

            const comment = document.getElementById('approvalComment').value.trim();

            Swal.fire({
                title: 'Approve This Claim?',
                html: comment
                    ? `<p class="mb-2">This will approve the mileage claim and process the reimbursement.</p>
                       <div class="alert alert-info mt-3 mb-0" style="font-size: 0.875rem; text-align: left;">
                           <strong>Your comment:</strong><br>${comment}
                       </div>`
                    : "This will approve the mileage claim and process the reimbursement.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Yes, Approve',
                cancelButtonText: 'Cancel',
                reverseButtons: true,
                showLoaderOnConfirm: true,

                preConfirm: async () => {
                    try {
                        const response = await fetch(`/Mileage/Approve/${claimId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                            },
                            // body: comment, 
                            body: JSON.stringify(comment)
                        });

                        const data = await response.json();

                        if (!response.ok || !data.success) {
                            throw new Error(data.message || 'Failed to approve claim');
                        }

                        return data;

                    } catch (error) {
                        Swal.fire({
                            title: 'Approval Failed',
                            text: error.message || 'An unexpected error occurred.',
                            icon: 'error',
                            confirmButtonColor: '#ef4444',
                            confirmButtonText: 'OK'
                        });

                        return false;
                    }
                },

                allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {

                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Approved!',
                        text: 'The mileage claim has been approved successfully.',
                        icon: 'success',
                        confirmButtonColor: '#10b981',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        window.location.href = '/Mileage/Index';
                    });
                }
            });
        }


                    function rejectClaim(claimId) {

            const comment = document.getElementById('approvalComment').value.trim();

            Swal.fire({
                title: 'Reject This Claim?',
                html: comment
                    ? `<p class="mb-2">This will reject the mileage claim.</p>
                       <div class="alert alert-warning mt-3 mb-0" style="font-size: 0.875rem; text-align: left;">
                           <strong>Your comment:</strong><br>${comment}
                       </div>`
                    : "This will reject the mileage claim.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Yes, Reject',
                cancelButtonText: 'Cancel',
                reverseButtons: true,
                showLoaderOnConfirm: true,

                preConfirm: async () => {
                    try {
                        const response = await fetch(`/Mileage/Reject/${claimId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                            },
                            body: JSON.stringify(comment)
                        });

                        const data = await response.json();

                        if (!response.ok || !data.success) {
                            throw new Error(data.message || 'Failed to reject claim');
                        }

                        return data;

                    } catch (error) {
                        Swal.fire({
                            title: 'Rejection Failed',
                            text: error.message || 'An unexpected error occurred.',
                            icon: 'error',
                            confirmButtonColor: '#ef4444',
                            confirmButtonText: 'OK'
                        });

                        return false;
                    }
                },

                allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {

                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Rejected!',
                        text: 'The mileage claim has been rejected successfully.',
                        icon: 'success',
                        confirmButtonColor: '#ef4444',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        window.location.href = '/Mileage/Index';
                    });
                }
            });
        }

        </script>
    }
