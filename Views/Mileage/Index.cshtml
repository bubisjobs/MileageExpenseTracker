@model IEnumerable<MileageClaim>
@using MileageExpenseTracker

@{
    ViewData["Title"] = "My Mileage Claims";
}


<div class="container" style="max-width: 1400px; margin: 0 auto; padding: 1.5rem;">
    <!-- Header -->
    <div class="custom-card mb-4" style="padding: 1.5rem;">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="text-dark-custom" style="font-size: 1.875rem; font-weight: 700; margin-bottom: 0.25rem;">Mileage Claims</h1>
                <p class="text-muted-custom" style="margin: 0; font-size: 1rem;">Track and submit your mileage reimbursement claims</p>
            </div>
            <a asp-action="Create" class="btn-primary-custom text-decoration-none d-flex align-items-center gap-2 text-white">
                <i class="bi bi-plus-circle"></i>
                New Claim
            </a>
        </div>
    </div>

    <!-- Status Filter Tabs -->
    <div class="custom-card mb-4" style="padding: 1rem 1.5rem;">
        <div class="d-flex gap-2 flex-wrap">
            <button class="btn btn-sm status-filter-btn active" data-status="all" style="padding: 0.5rem 1rem; border-radius: 0.375rem; border: 1px solid #d1d5db; background: white; font-weight: 500; transition: all 0.2s;">
                All Claims
            </button>
            @* <button class="btn btn-sm status-filter-btn" data-status="Draft" style="padding: 0.5rem 1rem; border-radius: 0.375rem; border: 1px solid #d1d5db; background: white; font-weight: 500; transition: all 0.2s;"> *@
            @*     Draft *@
            @* </button> *@
            <button class="btn btn-sm status-filter-btn" data-status="SubmittedToTeamLead" style="padding: 0.5rem 1rem; border-radius: 0.375rem; border: 1px solid #d1d5db; background: white; font-weight: 500; transition: all 0.2s;">
                Pending Team Lead 
            </button>
            <button class="btn btn-sm status-filter-btn" data-status="TeamLeadApproved" style="padding: 0.5rem 1rem; border-radius: 0.375rem; border: 1px solid #d1d5db; background: white; font-weight: 500; transition: all 0.2s;">
                Team Lead Approved and Pending Finance
            </button>
            @* <button class="btn btn-sm status-filter-btn" data-status="SubmittedToFinance" style="padding: 0.5rem 1rem; border-radius: 0.375rem; border: 1px solid #d1d5db; background: white; font-weight: 500; transition: all 0.2s;"> *@
            @*     Pending Finance *@
            @* </button> *@
            <button class="btn btn-sm status-filter-btn" data-status="FinanceApproved" style="padding: 0.5rem 1rem; border-radius: 0.375rem; border: 1px solid #d1d5db; background: white; font-weight: 500; transition: all 0.2s;">
                Approved
            </button>
            <button class="btn btn-sm status-filter-btn" data-status="Rejected" style="padding: 0.5rem 1rem; border-radius: 0.375rem; border: 1px solid #d1d5db; background: white; font-weight: 500; transition: all 0.2s;">
                Rejected
            </button>
        </div>
    </div>

    <!-- DataTable Card -->
    <div class="custom-card" style="padding: 1.5rem;">
        <table id="claimsTable" class="table table-hover table-striped" style="width:100%">
            <thead style="background-color: var(--gray-50);">
                <tr>
                    <th>Period</th>
                    <th>Staff Name</th>
                    <th>Status</th>
                    <th>Distance (km)</th>
                    <th>Reimbursement</th>
                    <th>Trips</th>
                    <th>Submitted</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var claim in Model)
                {
                    <tr>
                        <td data-order="@claim.StartDate.ToString("yyyy-MM-dd")">
                            @claim.StartDate.ToString("MMM dd") - @claim.EndDate.ToString("MMM dd, yyyy")
                        </td>
                        <td>@(claim.EmployeeName)</td>
                        <td data-order="@claim.Status.ToString()">
                            @{
                                var (statusText, statusClass) = claim.Status.ToString() switch
                                {
                                    // "Draft" => ("Draft", "status-draft"),
                                    "SubmittedToTeamLead" => ("Pending Team Lead", "status-submitted"),
                                    "TeamLeadApproved" => ("Team Lead Approved and Pending Finance", "status-approved"),
                                    "TeamLeadRejected" => ("Team Lead Rejected ", "status-rejected"),
                                    // "SubmittedToFinance" => ("Pending Finance", "status-submitted"),
                                    "FinanceApproved" => ("Finance Approved", "status-submitted"),
                                    "FinanceRejected" => ("Finance Rejected", "status-rejected"),
                                    "Rejected" => ("Rejected", "status-rejected"),
                                    "Approved" => ("Approved", "status-approved"),
                                    _ => ("Unknown", "status-draft")
                                };
                            }
                            <span class="status-badge @statusClass" data-status="@claim.Status.ToString()">@statusText</span>
                        </td>
                        <td data-order="@(claim.TotalKilometers ?? 0)">
                            @(claim.TotalKilometers?.ToString("N2") ?? "0.00")
                        </td>
                        <td data-order="@(claim.TotalReimbursement ?? 0)">
                            $@(claim.TotalReimbursement?.ToString("N2") ?? "0.00")
                        </td>
                        <td>@claim.Trips.Count</td>
                        <td data-order="@(claim.SubmittedAt?.ToString("yyyy-MM-dd") ?? "")">
                            @if (claim.SubmittedAt != null)
                            {
                                @claim.SubmittedAt?.ToString("MMM dd, yyyy")
                            }
                            else
                            {
                                <span>—</span>
                            }
                        </td>
                        <td>
                            <a asp-action="Edit" asp-route-id="@claim.Id" class="btn btn-sm btn-secondary-custom text-decoration-none">
                                <i class="bi bi-eye"></i> View
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<style>
    /* Status Filter Buttons */
    .status-filter-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        border-color: #667eea !important;
    }

    .status-filter-btn:hover {
        background-color: #f3f4f6 !important;
        border-color: #9ca3af !important;
    }

    .status-filter-btn.active:hover {
        background: linear-gradient(135deg, #5568d3 0%, #6a4291 100%) !important;
    }

    /* DataTables Custom Styling */
    #claimsTable_wrapper .row {
        margin-bottom: 1rem;
    }

    #claimsTable_filter input {
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 0.5rem 0.75rem;
        margin-left: 0.5rem;
    }

        #claimsTable_filter input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

    #claimsTable_length select {
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 0.5rem 2rem 0.5rem 0.75rem;
        margin: 0 0.5rem;
    }

    .dataTables_info {
        color: #6b7280;
        font-size: 0.875rem;
    }

    .dataTables_paginate .pagination {
        gap: 0.25rem;
    }

    .page-link {
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 0.5rem 0.75rem;
        color: #374151;
        margin: 0 0.125rem;
    }

    .page-item.active .page-link {
        background-color: #3b82f6;
        border-color: #3b82f6;
        color: white;
    }

    .page-link:hover {
        background-color: #f3f4f6;
        border-color: #9ca3af;
    }

    table.dataTable thead th {
        font-weight: 600;
        font-size: 0.875rem;
        color: #374151;
        border-bottom: 2px solid #e5e7eb;
    }

    table.dataTable tbody td {
        vertical-align: middle;
        font-size: 0.875rem;
    }

    table.dataTable tbody tr:hover {
        background-color: #f9fafb !important;
    }

    /* Export Buttons */
    .dt-buttons {
        margin-bottom: 1rem;
    }

    .dt-button {
        background: white !important;
        border: 1px solid #d1d5db !important;
        color: #374151 !important;
        border-radius: 0.375rem !important;
        padding: 0.5rem 1rem !important;
        font-weight: 500 !important;
        margin-right: 0.5rem !important;
    }

        .dt-button:hover {
            background-color: #f3f4f6 !important;
            border-color: #9ca3af !important;
        }
</style>

<!-- jQuery (required for DataTables) -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

<script>
    $(document).ready(function() {
        // Initialize DataTable
        var table = $('#claimsTable').DataTable({
            // Pagination
            paging: true,
            pageLength: 10,
            lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],

            // Sorting
            order: [[0, 'desc']], // Sort by Period (date) descending by default

            // Search
            searching: true,

            // Styling
            dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                 '<"row"<"col-sm-12 col-md-6"B>>' +
                 '<"row"<"col-sm-12"tr>>' +
                 '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',

            // Export Buttons
            buttons: [
                {
                    extend: 'excel',
                    text: '<i class="bi bi-file-earmark-excel me-1"></i> Export Excel',
                    className: 'btn-sm',
                    exportOptions: {
                        columns: [0, 1, 2, 3, 4, 5, 6] // Exclude Actions column
                    }
                },
                {
                    extend: 'pdf',
                    text: '<i class="bi bi-file-earmark-pdf me-1"></i> Export PDF',
                    className: 'btn-sm',
                    exportOptions: {
                        columns: [0, 1, 2, 3, 4, 5, 6]
                    }
                },
                {
                    extend: 'print',
                    text: '<i class="bi bi-printer me-1"></i> Print',
                    className: 'btn-sm',
                    exportOptions: {
                        columns: [0, 1, 2, 3, 4, 5, 6]
                    }
                }
            ],

            // Responsive
            responsive: true,

            // Language customization
            language: {
                search: "Search claims:",
                lengthMenu: "Show _MENU_ claims",
                info: "Showing _START_ to _END_ of _TOTAL_ claims",
                infoEmpty: "No claims available",
                infoFiltered: "(filtered from _MAX_ total claims)",
                zeroRecords: "No matching claims found",
                emptyTable: "No claims available",
                paginate: {
                    first: "First",
                    last: "Last",
                    next: "Next",
                    previous: "Previous"
                }
            },

            // Column definitions
            columnDefs: [
                {
                    targets: 3, // Distance column
                    className: 'text-end'
                },
                {
                    targets: 4, // Reimbursement column
                    className: 'text-end'
                },
                {
                    targets: 5, // Trips column
                    className: 'text-center'
                },
                {
                    targets: 7, // Actions column
                    orderable: false,
                    className: 'text-center'
                }
            ]
        });

        // Status Filter Functionality
        $('.status-filter-btn').on('click', function() {
            // Update active state
            $('.status-filter-btn').removeClass('active');
            $(this).addClass('active');

            var status = $(this).data('status');

            if (status === 'all') {
                // Clear filter
                $.fn.dataTable.ext.search.pop();
            } else {
                // Remove previous custom filter if exists
                $.fn.dataTable.ext.search.pop();

                // Add custom filter
                $.fn.dataTable.ext.search.push(
                    function(settings, data, dataIndex) {
                        var statusBadge = $(table.row(dataIndex).node()).find('.status-badge');
                        var rowStatus = statusBadge.data('status');

                        // Handle combined statuses
                        if (status === 'Rejected') {
                            return rowStatus === 'TeamLeadRejected' ||
                                   rowStatus === 'FinanceRejected' ||
                                   rowStatus === 'Rejected';
                        }

                        if (status === 'FinanceApproved') {
                            return rowStatus === 'FinanceApproved' ||
                                   rowStatus === 'Approved';
                        }

                        return rowStatus === status;
                    }
                );
            }

            // Redraw table
            table.draw();
        });

        // Custom search highlight
        $('#claimsTable_filter input').on('keyup', function() {
            var searchTerm = this.value;
            // You can add custom highlighting here if needed
        });
    });
</script>

@section Scripts {
    <script>
        // SweetAlert for Success/Error messages
        @if (TempData["Success"] != null)
        {
            <text>
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: '@TempData["Success"]',
                    confirmButtonColor: '#10b981',
                    timer: 3000,
                    timerProgressBar: true
                });
            </text>
        }

        @if (TempData["Error"] != null)
        {
            <text>
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: '@TempData["Error"]',
                    confirmButtonColor: '#ef4444'
                });
            </text>
        }
    </script>
}